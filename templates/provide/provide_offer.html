{% load l10n %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provide | Optimi Dataspace</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap">
    <style>
        :root {
            --brand-gradient: linear-gradient(135deg, #0d6efd, #6610f2);
            --brand-bg: radial-gradient(circle at top, #f5f9ff 0%, #ffffff 60%);
            --card-radius: 24px;
            --shadow-lg: 0 25px 45px rgba(13, 110, 253, 0.20);
            --shadow-sm: 0 12px 24px rgba(15, 23, 42, 0.08);
            --text-main: #0f172a;
            --text-muted: #64748b;
        }
        body {
            background: var(--brand-bg);
            font-family: "Inter", "Helvetica Neue", Arial, sans-serif;
            color: var(--text-main);
            min-height: 100vh;
        }
        .hero {
            background: var(--brand-gradient);
            color: #fff;
            border-radius: var(--card-radius);
            padding: 42px 36px;
            box-shadow: var(--shadow-lg);
            position: relative;
            overflow: hidden;
        }
        .hero::after,
        .hero::before {
            content: "";
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.20);
        }
        .hero::after {
            width: 200px;
            height: 200px;
            top: -60px;
            right: -40px;
        }
        .hero::before {
            width: 140px;
            height: 140px;
            bottom: -40px;
            left: -30px;
        }
        .stepper {
            display: flex;
            gap: 14px;
            flex-wrap: wrap;
            margin-top: 28px;
        }
        .stepper-card {
            flex: 1 1 180px;
            background: rgba(255, 255, 255, 0.18);
            border-radius: 18px;
            padding: 14px 18px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        .step-index {
            width: 34px;
            height: 34px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.95rem;
            background: rgba(255, 255, 255, 0.22);
        }
        .stepper-card.completed .step-index {
            background: #22c55e;
            color: #fff;
        }
        .stepper-card.active {
            background: rgba(255, 255, 255, 0.32);
        }
        .overview-card,
        .form-card {
            border-radius: var(--card-radius);
            box-shadow: var(--shadow-sm);
            border: none;
            background: #fff;
        }
        .overview-card h3 {
            font-size: 1.2rem;
            font-weight: 600;
        }
        .chip {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 0.8rem;
            font-weight: 600;
            margin: 2px 4px 2px 0;
        }
        .chip.brand {
            background: rgba(13, 110, 253, 0.12);
            color: #0d6efd;
        }
        .chip.soft {
            background: #e0f2fe;
            color: #0369a1;
        }
        .chip.neutral {
            background: #e2e8f0;
            color: #1e293b;
        }
        .section-heading {
            font-weight: 600;
            font-size: 1.05rem;
        }
        .helper-text {
            font-size: 0.9rem;
            color: var(--text-muted);
        }
        .btn-primary-rounded {
            border-radius: 999px;
            background: var(--brand-gradient);
            border: none;
            padding: 0.65rem 1.8rem;
            font-weight: 600;
        }
        .btn-outline-rounded {
            border-radius: 999px;
            border: 1px solid #64748b;
            color: #1f2937;
            font-weight: 600;
            padding: 0.65rem 1.6rem;
            background: transparent;
        }
        .alert-rounded {
            border-radius: 18px;
            border: none;
            padding: 1rem 1.25rem;
            display: flex;
            align-items: flex-start;
            gap: 0.8rem;
        }
        .alert-rounded .icon-wrap {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1rem;
        }
        .code-block {
            background: #0f172a;
            color: #f8fafc;
            border-radius: 16px;
            padding: 16px 20px;
            font-size: 0.9rem;
            position: relative;
            font-family: "JetBrains Mono", "SFMono-Regular", Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
        }
        .code-block button {
            position: absolute;
            top: 14px;
            right: 14px;
            border: none;
            background: rgba(248, 250, 252, 0.12);
            color: #e2e8f0;
            border-radius: 999px;
            padding: 6px 14px;
            font-size: 0.8rem;
            display: inline-flex;
            align-items: center;
            gap: 6px;
        }
        .section-card {
            border: 1px solid #e2e8f0;
            border-radius: 18px;
            padding: 24px;
            margin-bottom: 18px;
        }
        .form-control,
        .form-select {
            border-radius: 14px;
            border: 1px solid #cbd5f5;
            padding: 0.75rem 0.95rem;
        }
        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.12);
            border-color: #0d6efd;
        }
        .error-text {
            color: #dc2626;
            font-size: 0.85rem;
            margin-top: 6px;
        }
        .working-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            border-radius: 999px;
            background: rgba(13, 110, 253, 0.12);
            color: #0d6efd;
            padding: 6px 14px;
            font-size: 0.85rem;
            font-weight: 600;
        }
        .list-hint li + li {
            margin-top: 6px;
        }
        .table-hint tbody tr:nth-child(odd) {
            background: rgba(241, 245, 249, 0.4);
        }
        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <section class="hero mb-5">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <p class="text-uppercase fw-semibold mb-2" style="letter-spacing: 2px;">Provider Journey</p>
                    <h1 class="fw-bold mb-3">Share brilliant data products with a smile</h1>
                    <p class="mb-0">Create, describe, publish, and monitor your offer in one flow. We’ll keep things cheerful, plain-English, and on track.</p>
                </div>
            </div>
            <div class="stepper">
                {% for step in progress_steps %}
                <div class="stepper-card {% if step.status == 'completed' %}completed{% elif step.status == 'active' %}active{% endif %}">
                    <span class="step-index">
                        {% if step.status == 'completed' %}
                        <i class="bi bi-check-lg"></i>
                        {% else %}
                        {{ forloop.counter }}
                        {% endif %}
                    </span>
                    <div>
                        <div class="fw-semibold">{{ step.label }}</div>
                        <small class="text-white-50">{{ step.caption }}</small>
                    </div>
                </div>
                {% endfor %}
            </div>
        </section>

        {% if messages %}
            {% for message in messages %}
            <div class="alert alert-rounded {% if message.tags == 'success' %}alert-success{% elif message.tags == 'error' %}alert-danger{% else %}alert-info{% endif %} mb-4">
                <span class="icon-wrap {% if message.tags == 'success' %}bg-success-subtle text-success{% elif message.tags == 'error' %}bg-danger-subtle text-danger{% else %}bg-info-subtle text-info{% endif %}">
                    {% if message.tags == 'success' %}<i class="bi bi-emoji-smile-fill"></i>
                    {% elif message.tags == 'error' %}<i class="bi bi-emoji-frown-fill"></i>
                    {% else %}<i class="bi bi-info-circle-fill"></i>{% endif %}
                </span>
                <div class="flex-grow-1">
                    <div class="fw-semibold">{% if message.tags == 'success' %}All set!{% elif message.tags == 'error' %}Heads up{% else %}Quick note{% endif %}</div>
                    <div>{{ message }}</div>
                </div>
            </div>
            {% endfor %}
        {% endif %}

        <div class="row g-4 align-items-start">
            <div class="col-xl-4">
                <div class="card overview-card p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h3 class="mb-1">Account</h3>
                        {% if request.user.is_authenticated %}
                            <span class="chip soft"><span class="status-dot bg-success"></span> Signed in</span>
                        {% else %}
                            <span class="chip neutral"><span class="status-dot bg-secondary"></span> Guest</span>
                        {% endif %}
                    </div>
                    {% if request.user.is_authenticated %}
                        <p class="text-muted mb-3">You’re authenticated via the shared auth service.</p>
                        <ul class="list-unstyled text-muted small mb-3">
                            <li class="mb-1"><i class="bi bi-person-circle text-primary me-2"></i>{{ request.user.username|default:"—" }}</li>
                            <li class="mb-1"><i class="bi bi-envelope text-primary me-2"></i>{{ request.user.email|default:"—" }}</li>
                            <li class="mb-1"><i class="bi bi-shield-check text-primary me-2"></i>ID: {{ request.user.id|default:"—" }}</li>
                        </ul>
                        <div class="d-flex gap-2 flex-wrap">
                            <button type="button" class="btn btn-outline-rounded btn-sm" id="logoutBtn" data-logout-url="{{ auth_logout_url }}" data-login-url="{{ auth_login_url }}"><i class="bi bi-box-arrow-right"></i> Logout</button>
                            <!--<button type="button" class="btn btn-outline-rounded btn-sm" id="profileBtn" data-profile-url="{{ auth_profile_proxy_url }}" data-login-url="{{ auth_login_url }}"><i class="bi bi-person-badge"></i> Profile API</button>-->
                            <button type="button" class="btn btn-outline-rounded btn-sm d-none" onclick="window.location.href='{% url 'provide:my_offers' %}'">
                                <i class="bi bi-folder2-open"></i> My Offers
                            </button>


                        </div>
                        <div class="mt-3" id="profileResult" style="display:none;">
                            <div class="small text-muted mb-1">Profile response</div>
                            <pre class="bg-light p-2 rounded-3" style="white-space: pre-wrap;" id="profileResultText"></pre>
                        </div>
                    {% else %}
                        <p class="text-muted mb-3">Not signed in. Use the auth service to continue.</p>
                        <a class="btn btn-primary-rounded btn-sm" href="{{ auth_login_url }}?next={{ request.build_absolute_uri|urlencode }}"><i class="bi bi-box-arrow-in-right"></i> Go to login</a>
                    {% endif %}
                </div>

                <div class="card overview-card p-4 mb-4">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <h3>Offer snapshot</h3>
                        <span class="chip brand"><i class="bi bi-lightning-charge-fill"></i> {{ current_stage_label }}</span>
                    </div>
                    <p class="text-muted mb-3">{{ offer_snapshot.description }}</p>
                    <div class="mb-3">
                        <div class="fw-semibold text-uppercase text-muted small mb-2">Keywords</div>
                        {% if offer_snapshot.keywords %}
                            {% for keyword in offer_snapshot.keywords %}
                                <span class="chip soft"><i class="bi bi-hash"></i>{{ keyword }}</span>
                            {% endfor %}
                        {% else %}
                            <span class="text-muted small">Add a few keywords to help consumers spot your offer.</span>
                        {% endif %}
                    </div>
                    <div class="row g-3">
                        <div class="col-12">
                            <div class="p-3 rounded-4 border border-light-subtle bg-light">
                                <div class="text-uppercase text-muted small">Publishing to</div>
                                <div class="fw-semibold">{{ data_space_connector_url }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 rounded-4 border border-light-subtle">
                                <div class="text-uppercase text-muted small">Access opens</div>
                                <div class="fw-semibold">{{ offer_snapshot.start|default:"—" }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 rounded-4 border border-light-subtle">
                                <div class="text-uppercase text-muted small">Access ends</div>
                                <div class="fw-semibold">{{ offer_snapshot.end|default:"—" }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 rounded-4 border border-light-subtle">
                                <div class="text-uppercase text-muted small">Data model</div>
                                <div class="fw-semibold">{{ offer_snapshot.data_model|default:"—" }}</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="p-3 rounded-4 border border-light-subtle">
                                <div class="text-uppercase text-muted small">Purpose of use</div>
                                <div class="fw-semibold">{{ offer_snapshot.purpose_of_use|default:"—" }}</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card overview-card p-4 mb-4">
                    <h3 class="mb-3">Friendly hints</h3>
                    <ul class="list-unstyled list-hint text-muted mb-0">
                        <li><i class="bi bi-stars text-primary me-2"></i> Keep titles playful but specific — it helps consumers trust the content faster.</li>
                        <li><i class="bi bi-emoji-smile text-primary me-2"></i> Plain-language descriptions beat jargon every time.</li>
                        <li><i class="bi bi-geo-alt text-primary me-2"></i> Verify the access URL responds quickly — it drives confidence when testing.</li>
                    </ul>
                </div>

                <div class="card overview-card p-4">
                    <h3 class="mb-3">Quick actions</h3>
                    <table class="table table-borderless align-middle table-hint mb-0">
                        <tbody>
                            <tr>
                                <td class="text-muted small">Monitor</td>
                                <td><span class="chip neutral"><i class="bi bi-graph-up-arrow"></i> Coming soon</span></td>
                            </tr>
                            <tr>
                                <td class="text-muted small">Test access</td>
                                <td><span class="chip neutral"><i class="bi bi-clock-history"></i> Connector checks disabled</span></td>
                            </tr>
                            <tr>
                                <td class="text-muted small">Share</td>
                                <td>
                                    {% if data_space_consumer_url %}
                                    <a class="btn btn-outline-rounded btn-sm" href="{{ data_space_consumer_url }}" target="_blank" rel="noopener noreferrer">
                                        Explore Consume
                                    </a>
                                    {% else %}
                                    <span class="chip soft"><i class="bi bi-info-circle"></i> Consumer URL not configured</span>
                                    {% endif %}
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="col-xl-8">
                <div class="card form-card p-4 p-xl-5">
                    <div class="d-flex align-items-center justify-content-between gap-3 mb-4 flex-wrap">
                        <div>
                            <div class="text-uppercase text-muted small fw-semibold">Step 2 · Describe</div>
                            <h2 class="fw-bold mb-1">Let’s describe your brilliant offer</h2>
                            <p class="helper-text mb-0">We’ll use this to publish a contract-ready resource to other data space participants.</p>
                        </div>
                        <div class="working-pill"><span class="spinner-border spinner-border-sm"></span> We’ll keep things running smoothly</div>
                    </div>

                    <form id="metadata-form" method="post" novalidate>
                        {% csrf_token %}

                        {% if form.errors %}
                        <div class="alert alert-danger d-flex flex-column gap-2">
                            <div class="fw-semibold"><i class="bi bi-x-octagon me-1"></i> We still need a few fixes before publishing:</div>
                            <ul class="mb-0 ps-3">
                                {% for field in form %}
                                    {% if field.errors %}
                                    <li>{{ field.label }} — {{ field.errors|join:', ' }}</li>
                                    {% endif %}
                                {% endfor %}
                                {% if form.non_field_errors %}
                                    <li>{{ form.non_field_errors|join:', ' }}</li>
                                {% endif %}
                            </ul>
                        </div>
                        {% endif %}

                        <section class="section-card">
                            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                                <div>
                                    <div class="section-heading mb-1">Offer basics</div>
                                    <p class="helper-text mb-0">Tell future consumers what value this offer unlocks.</p>
                                </div>
                                <span class="chip brand"><i class="bi bi-pencil-square"></i> Create + Describe</span>
                            </div>

                            <div class="mb-3">
                                <label for="offer_title" class="form-label fw-semibold">Offer title</label>
                                <input type="text" id="offer_title" name="offer_title" class="form-control" placeholder="e.g. Helsinki hourly weather observations" value="{{ form.offer_title.value|default:'' }}" required>
                                <div class="helper-text mt-1">Aim for a clear statement in under 60 characters.</div>
                                {% for error in form.offer_title.errors %}
                                    <div class="error-text"><i class="bi bi-exclamation-circle"></i> {{ error }}</div>
                                {% endfor %}
                            </div>

                            <div class="mb-3">
                                <label for="offer_description" class="form-label fw-semibold">Short description</label>
                                <textarea id="offer_description" name="offer_description" class="form-control" rows="3" placeholder="A playful summary that helps people decide fast." required>{{ form.offer_description.value|default:'' }}</textarea>
                                <div class="helper-text mt-1">Explain the use-case in friendly language, in one or two sentences.</div>
                                {% for error in form.offer_description.errors %}
                                    <div class="error-text"><i class="bi bi-exclamation-circle"></i> {{ error }}</div>
                                {% endfor %}
                            </div>

                            <div class="mb-3">
                                <label for="keywords" class="form-label fw-semibold">Keywords</label>
                                <input type="text" id="keywords" name="keywords" class="form-control" placeholder="weather, climate, helsinki" value="{{ form.keywords.value|default:'' }}" required>
                                <div class="helper-text mt-1">Comma-separated list. We’ll turn them into discovery chips automatically.</div>
                                {% for error in form.keywords.errors %}
                                    <div class="error-text"><i class="bi bi-exclamation-circle"></i> {{ error }}</div>
                                {% endfor %}
                            </div>
                            <div class="row g-3">
                                <div class="col-lg-6">
                                    <label for="data_model" class="form-label fw-semibold">Data model</label>
                                    <select id="data_model" name="data_model" class="form-select" required>
                                        {% for value,label in form.data_model.field.choices %}
                                            <option value="{{ value }}" {% if form.data_model.value == value %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="helper-text mt-1">Select the canonical model governing this offer’s structure.</div>
                                    {% for error in form.data_model.errors %}
                                        <div class="error-text"><i class="bi bi-exclamation-circle"></i> {{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-lg-6">
                                    <label for="purpose_of_use" class="form-label fw-semibold">Purpose of use</label>
                                    <select id="purpose_of_use" name="purpose_of_use" class="form-select" required>
                                        {% for value,label in form.purpose_of_use.field.choices %}
                                            <option value="{{ value }}" {% if form.purpose_of_use.value == value %}selected{% endif %}>{{ label }}</option>
                                        {% endfor %}
                                    </select>
                                    <div class="helper-text mt-1">Tell consumers how this offer is intended to be used.</div>
                                    {% for error in form.purpose_of_use.errors %}
                                        <div class="error-text"><i class="bi bi-exclamation-circle"></i> {{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="row g-3">
                                <div class="col-lg-6">
                                    <label for="offer_publisher" class="form-label fw-semibold">Publisher URL</label>
                                    <input type="url" id="offer_publisher" name="offer_publisher" class="form-control" placeholder="https://..." value="{{ form.offer_publisher.value|default:'' }}" required>
                                    <div class="helper-text mt-1">Link to your organisation or product home.</div>
                                    {% for error in form.offer_publisher.errors %}
                                        <div class="error-text"><i class="bi bi-exclamation-circle"></i> {{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-lg-3">
                                    <label for="offer_language" class="form-label fw-semibold">Language</label>
                                    <input type="text" id="offer_language" name="offer_language" class="form-control" placeholder="EN" value="{{ form.offer_language.value|default:'' }}" required>
                                    {% for error in form.offer_language.errors %}
                                        <div class="error-text"><i class="bi bi-exclamation-circle"></i> {{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>
                        </section>

                        <section class="section-card">
                            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                                <div>
                                    <div class="section-heading mb-1">Usage rights</div>
                                    <p class="helper-text mb-0">Pin the license separately so compliance teams can find it fast.</p>
                                </div>
                                <span class="chip brand"><i class="bi bi-shield-lock"></i> Trust layer</span>
                            </div>
                            <div class="mb-3">
                                <label for="offer_license" class="form-label fw-semibold">License</label>
                                <select id="offer_license" name="offer_license" class="form-select" required>
                                    <option value="">Choose...</option>
                                    {% for value,label in license_choices %}
                                        <option value="{{ value }}" {% if form.offer_license.value == value %}selected{% endif %}>{{ label }}</option>
                                    {% endfor %}
                                </select>
                                {% for error in form.offer_license.errors %}
                                    <div class="error-text"><i class="bi bi-exclamation-circle"></i> {{ error }}</div>
                                {% endfor %}
                            </div>
                        </section>

                        <section class="section-card">
                            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                                <div>
                                    <div class="section-heading mb-1">Artifact access</div>
                                    <p class="helper-text mb-0">Provide the URL consumers should call. We’ll validate connectivity for you.</p>
                                </div>
                                <span class="chip brand"><i class="bi bi-cloud-arrow-up"></i> Publish-ready</span>
                            </div>

                            <div class="mb-3">
                                <label for="accessUrl" class="form-label fw-semibold">Access URL</label>
                                <input type="url" id="accessUrl" name="accessUrl" class="form-control" placeholder="https://..." value="{{ form.accessUrl.value|default:'' }}" required>
                                {% for error in form.accessUrl.errors %}
                                    <div class="error-text"><i class="bi bi-exclamation-circle"></i> {{ error }}</div>
                                {% endfor %}
                            </div>

                            <div class="mb-3">
                                <label for="auth_type" class="form-label fw-semibold">Access URL authentication</label>
                                <select id="auth_type" name="auth_type" class="form-select">
                                    <option value="none" {% if form.auth_type.value == 'none' or not form.auth_type.value %}selected{% endif %}>None</option>
                                    <option value="basic" {% if form.auth_type.value == 'basic' %}selected{% endif %}>Basic (username/password)</option>
                                    <option value="bearer" {% if form.auth_type.value == 'bearer' %}selected{% endif %}>Bearer token</option>
                                </select>
                                {% for error in form.auth_type.errors %}
                                    <div class="error-text"><i class="bi bi-exclamation-circle"></i> {{ error }}</div>
                                {% endfor %}
                            </div>

                            <div class="row g-3" id="basicAuthFields">
                                <div class="col-md-6">
                                    <label for="auth_username" class="form-label fw-semibold">Username</label>
                                    <input type="text" id="auth_username" name="auth_username" class="form-control" value="{{ form.auth_username.value|default:'' }}">
                                    {% for error in form.auth_username.errors %}
                                        <div class="error-text"><i class="bi bi-exclamation-circle"></i> {{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-6">
                                    <label for="auth_password" class="form-label fw-semibold">Password</label>
                                    <input type="password" id="auth_password" name="auth_password" class="form-control" value="{{ form.auth_password.value|default:'' }}">
                                    {% for error in form.auth_password.errors %}
                                        <div class="error-text"><i class="bi bi-exclamation-circle"></i> {{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="mt-3" id="bearerAuthField">
                                <label for="auth_token" class="form-label fw-semibold">Bearer token</label>
                                <input type="password" id="auth_token" name="auth_token" class="form-control" value="{{ form.auth_token.value|default:'' }}">
                                {% for error in form.auth_token.errors %}
                                    <div class="error-text"><i class="bi bi-exclamation-circle"></i> {{ error }}</div>
                                {% endfor %}
                            </div>

                            <div class="d-flex flex-wrap gap-2 mt-3">
                                <button type="button" class="btn btn-outline-primary btn-sm" id="testAccessBtn" data-test-url="{% url 'provide:test_access' %}">
                                    <i class="bi bi-wifi"></i> Test access URL
                                </button>
                                <div class="small text-muted align-self-center" id="testAccessHint">Runs a lightweight request to the access URL.</div>
                            </div>
                            <div class="mt-3" id="testAccessResult" style="display:none;">
                                <div class="small text-muted mb-1">Test result</div>
                                <pre class="bg-light p-2 rounded-3" style="white-space: pre-wrap;" id="testAccessResultText"></pre>
                            </div>
                        </section>

                        <section class="section-card">
                            <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
                                <div>
                                    <div class="section-heading mb-1">Contract window</div>
                                    <p class="helper-text mb-0">Choose when the offer is usable. We’ll wrap it in a friendly IDS policy for you.</p>
                                </div>
                                <span class="chip brand"><i class="bi bi-clipboard-check"></i> Auto-contract</span>
                            </div>

                            <div class="row g-3">
                                <div class="col-md-6">
                                    <label for="start" class="form-label fw-semibold">Access start</label>
                                    <input type="datetime-local" id="start" name="start" class="form-control" value="{{ form.start.value|default:'' }}" required>
                                    {% for error in form.start.errors %}
                                        <div class="error-text"><i class="bi bi-exclamation-circle"></i> {{ error }}</div>
                                    {% endfor %}
                                </div>
                                <div class="col-md-6">
                                    <label for="end" class="form-label fw-semibold">Access end</label>
                                    <input type="datetime-local" id="end" name="end" class="form-control" value="{{ form.end.value|default:'' }}" required>
                                    {% for error in form.end.errors %}
                                        <div class="error-text"><i class="bi bi-exclamation-circle"></i> {{ error }}</div>
                                    {% endfor %}
                                </div>
                            </div>

                            <div class="mt-3">
                                <label for="access_policy" class="form-label fw-semibold">Policy template</label>
                                <select id="access_policy" name="access_policy" class="form-select" required>
                                    <option value="">Pick a policy type</option>
                                    <option value="between_dates" {% if form.access_policy.value == 'between_dates' %}selected{% endif %}>Access allowed between start and end dates</option>
                                </select>
                                <input type="hidden" id="policy_value" name="value" value="{{ form.value.value|default:'' }}">
                                {% for error in form.access_policy.errors %}
                                    <div class="error-text"><i class="bi bi-exclamation-circle"></i> {{ error }}</div>
                                {% endfor %}
                            </div>
                        </section>

                        <div class="d-flex gap-3 flex-wrap align-items-center">
                            <button type="submit" class="btn btn-primary-rounded d-flex align-items-center gap-2"><i class="bi bi-rocket-takeoff"></i>Publish</button>
                            {% if data_space_consumer_url %}
                            <a class="btn btn-outline-rounded d-flex align-items-center gap-2" href="{{ data_space_consumer_url }}" target="_blank" rel="noopener noreferrer"><i class="bi bi-compass"></i>Jump to consume</a>
                            {% endif %}
                            <span class="helper-text">Need a breather? You can safely come back later — your edits stay on this tab.</span>
                        </div>
                    </form>
                </div>

                <div class="card form-card mt-4 p-4 p-xl-5">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                        <div>
                            <h3 class="fw-semibold mb-1">Try it via curl</h3>
                            <p class="helper-text mb-0">Copy this snippet to automate a quick health check after publishing.</p>
                        </div>
                        <span class="chip neutral"><i class="bi bi-terminal"></i> Copy-friendly</span>
                    </div>
                    <div class="code-block" id="publishSnippet">
                        <button type="button" id="copySnippetBtn"><i class="bi bi-clipboard"></i> Copy</button>
                        curl -H "Authorization: Bearer &lt;token&gt;" \
  "{{ offer_snapshot.access_url|default:'https://example.com/dataset.json' }}"
                    </div>
                    <p class="helper-text mt-3 mb-0">Swap in a DAT from DAPS and you’re ready to monitor availability.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const copySnippetBtn = document.getElementById("copySnippetBtn");
            const snippetBlock = document.getElementById("publishSnippet");
            const logoutBtn = document.getElementById("logoutBtn");
            const profileBtn = document.getElementById("profileBtn");
            const profileResult = document.getElementById("profileResult");
            const profileResultText = document.getElementById("profileResultText");

            if (copySnippetBtn) {
                copySnippetBtn.addEventListener("click", () => {
                    const text = snippetBlock.textContent.trim();
                    navigator.clipboard.writeText(text).then(() => {
                        copySnippetBtn.innerHTML = '<i class="bi bi-clipboard-check"></i> Copied!';
                        setTimeout(() => copySnippetBtn.innerHTML = '<i class="bi bi-clipboard"></i> Copy', 2200);
                    });
                });
            }

            const getCookie = (name) => {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
                return null;
            };

            if (logoutBtn) {
                logoutBtn.addEventListener("click", async (e) => {
                    e.preventDefault();
                    const url = logoutBtn.dataset.logoutUrl;
                    const loginUrl = logoutBtn.dataset.loginUrl;
                    const expireCookie = (name) => {
                        document.cookie = `${name}=; Max-Age=0; path=/;`;
                    };
                    try {
                        const resp = await fetch(url, {
                            method: "POST",
                            credentials: "include",
                            headers: {
                                "X-CSRFToken": getCookie("csrftoken") || "",
                            },
                        });
                        if (!resp.ok) {
                            console.warn("Logout non-200 response", resp.status);
                        }
                    } catch (err) {
                        console.error("Logout error", err);
                    } finally {
                        // Clear known auth cookies on the browser side to prevent reuse
                        const providerCookie = "{{ provider_cookie_name|default:'provider_sessionid' }}";
                        ["sessionid", "auth_sessionid", "csrftoken", providerCookie].forEach(expireCookie);
                        if (loginUrl) {
                            const next = encodeURIComponent(window.location.origin + window.location.pathname);
                            window.location.href = `${loginUrl}?next=${next}`;
                        } else {
                            window.location.reload();
                        }
                    }
                });
            }

            const authTypeSelect = document.getElementById("auth_type");
            const basicAuthFields = document.getElementById("basicAuthFields");
            const bearerAuthField = document.getElementById("bearerAuthField");
            const updateAuthFields = () => {
                const authType = authTypeSelect ? authTypeSelect.value : "none";
                if (basicAuthFields) {
                    basicAuthFields.style.display = authType === "basic" ? "flex" : "none";
                }
                if (bearerAuthField) {
                    bearerAuthField.style.display = authType === "bearer" ? "block" : "none";
                }
            };
            if (authTypeSelect) {
                authTypeSelect.addEventListener("change", updateAuthFields);
                updateAuthFields();
            }

            const testAccessBtn = document.getElementById("testAccessBtn");
            const testAccessResult = document.getElementById("testAccessResult");
            const testAccessResultText = document.getElementById("testAccessResultText");
            if (testAccessBtn) {
                testAccessBtn.addEventListener("click", async (e) => {
                    e.preventDefault();
                    const url = testAccessBtn.dataset.testUrl;
                    const accessUrlInput = document.getElementById("accessUrl");
                    const authType = authTypeSelect ? authTypeSelect.value : "none";
                    const accessUrlValue = (accessUrlInput ? accessUrlInput.value : "").trim();
                    if (!accessUrlValue) {
                        testAccessResultText.textContent = "Access URL is required.";
                        testAccessResult.style.display = "block";
                        return;
                    }
                    const payload = new URLSearchParams();
                    payload.set("accessUrl", accessUrlValue);
                    payload.set("auth_type", authType);
                    if (authType === "basic") {
                        const username = (document.getElementById("auth_username")?.value || "").trim();
                        const password = document.getElementById("auth_password")?.value || "";
                        if (username) {
                            payload.set("auth_username", username);
                        }
                        if (password) {
                            payload.set("auth_password", password);
                        }
                    }
                    if (authType === "bearer") {
                        const token = document.getElementById("auth_token")?.value || "";
                        if (token) {
                            payload.set("auth_token", token);
                        }
                    }
                    testAccessBtn.disabled = true;
                    testAccessBtn.innerHTML = '<i class="bi bi-hourglass-split"></i> Testing...';
                    try {
                        const resp = await fetch(`${url}?${payload.toString()}`, {
                            method: "GET",
                            credentials: "same-origin",
                        });
                        let bodyText = "";
                        try {
                            const contentType = resp.headers.get("Content-Type") || "";
                            if (contentType.includes("application/json")) {
                                const data = await resp.json();
                                bodyText = JSON.stringify(data, null, 2);
                            } else {
                                bodyText = await resp.text();
                            }
                        } catch (err) {
                            bodyText = `Unable to parse response body: ${err}`;
                        }
                        testAccessResultText.textContent = `Status ${resp.status} ${resp.statusText}\n\n${bodyText || "No response body"}`;
                        testAccessResult.style.display = "block";
                    } catch (err) {
                        testAccessResultText.textContent = `Error: ${err}`;
                        testAccessResult.style.display = "block";
                    } finally {
                        testAccessBtn.disabled = false;
                        testAccessBtn.innerHTML = '<i class="bi bi-wifi"></i> Test access URL';
                    }
                });
            }

            if (profileBtn) {
                profileBtn.addEventListener("click", async (e) => {
                    e.preventDefault();
                    const url = profileBtn.dataset.profileUrl;
                    const loginUrl = profileBtn.dataset.loginUrl;
                    try {
                        const resp = await fetch(url, { credentials: "include" });
                        if (resp.status === 401) {
                            if (loginUrl) {
                                const next = encodeURIComponent(window.location.href);
                                window.location.href = `${loginUrl}?next=${next}`;
                                return;
                            }
                        }
                        const text = await resp.text();
                        profileResultText.textContent = text || "No content";
                        profileResult.style.display = "block";
                        if (!resp.ok) {
                            profileResultText.textContent = `Status ${resp.status}: ${text}`;
                        }
                    } catch (err) {
                        profileResultText.textContent = `Error: ${err}`;
                        profileResult.style.display = "block";
                    }
                });
            }
        });
    </script>
</body>
</html>
