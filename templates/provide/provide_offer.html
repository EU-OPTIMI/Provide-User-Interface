{% load l10n %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Provide Offer to Data Space</title>
    <!-- Include Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Include FontAwesome for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" rel="stylesheet">
    <!-- Custom styles -->
    <style>
        body {
            background-color: #e9ecef;
            color: #333;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .navbar {
            background-color: #ffffff;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }
        .navbar-brand {
            font-weight: bold;
            color: #007bff;
        }
        .btn-copy {
            border: none;
            background: transparent;
            color: #007bff;
            cursor: pointer;
        }
        .btn-copy:hover {
            color: #0056b3;
        }
        .card {
            border-radius: 0.75rem;
            border: 1px solid #ddd;
            background-color: #ffffff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        .card-header {
            background-color: #007bff;
            color: white;
            border-bottom: 1px solid #ddd;
            font-size: 1.25rem;
        }
        .card-body {
            padding: 2rem;
        }
        .btn-primary {
            background-color: #007bff;
            border-color: #007bff;
        }
        .btn-primary:hover {
            background-color: #0056b3;
            border-color: #004085;
        }
        .readonly-input {
            background-color: #e9ecef;
            color: #6c757d;
            cursor: not-allowed;
        }
    </style>
</head>
<body>

    <!-- Navigation Bar -->
    <nav class="navbar navbar-expand-lg">
        <div class="container-fluid">
            <!-- Left: Title -->
            <a class="navbar-brand" href="#">Data Space</a>
            
            <!-- Middle: Copyable URL -->
            <div class="d-flex align-items-center mx-auto" style="max-width: 600px; flex-grow: 1;">
                <input type="text" class="form-control form-control-sm" id="dataSpaceUrl" value="{{ data_space_connector_url }}" readonly>
                <button class="btn btn-copy ms-2" id="copyUrlBtn">
                    <i class="fas fa-copy"></i>
                </button>
            </div>
        </div>
    </nav>

    <!-- Main Content -->
    <div class="container mt-5">
        <h1>Provide Offer to Data Space</h1>
        {% if messages %}
        <div class="mt-3">
            {% for message in messages %}
                <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %}">
                    {{ message }}
                </div>
            {% endfor %}
        </div>
        {% endif %}
        
        {% if debug_metadata %}
        <div class="card mb-4">
            <div class="card-header bg-info text-white">
                <i class="fas fa-bug"></i> Debug: Initial Metadata
            </div>
            <div class="card-body">
                <pre class="mb-0">{{ debug_metadata|pprint }}</pre>
            </div>
        </div>
        {% endif %}
        <div class="card">
            <div class="card-header d-flex align-items-center">
                <i class="fas fa-file-alt icon-header me-2"></i>
                <span>Providing the Offering</span>
            </div>
            <div class="card-body">
                <form id="metadata-form" method="post">
                    {% csrf_token %}
                    
                    <!-- Metadata fields -->
                    <h5 class="mb-4">Please Enter the Required Metadata</h5>
                    <hr>

                    <h4>Offer</h4>
                    <div class="form-group">
                        <label for="offer_title" class="form-label">Title </label>
                        <input type="text" id="offer_title" name="offer_title" class="form-control" required placeholder="My Offer Title" value="{{ form.offer_title.value|default:'' }}">
                    </div>
                    <div class="form-group">
                        <label for="offer_description" class="form-label">Description</label>
                        <input type="text" id="offer_description" name="offer_description" class="form-control" required placeholder="My Offer Description" value="{{ form.offer_description.value|default:'' }}">
                    </div>
                    <div class="form-group">
                        <label for="keywords" class="form-label">Keywords (comma-separated)</label>
                        <input type="text" id="keywords" name="keywords" class="form-control" required placeholder="JSON, Weather, Helsinki" value="{{ form.keywords.value|default:'' }}">
                    </div>
                    <div class="form-group">
                        <label for="offer_publisher" class="form-label">Publisher</label>
                        <input type="text" id="offer_publisher" name="offer_publisher" class="form-control" required placeholder="https://vtt.fi/publisher" value="{{ form.offer_publisher.value|default:'' }}">
                    </div>
                    <div class="form-group">
                        <label for="offer_language" class="form-label">Language</label>
                        <select id="offer_language" name="offer_language" class="form-control" required>
                            <option value="">Select language</option>
                            <option value="EN" {% if form.offer_language.value == 'EN' %}selected{% endif %}>EN</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="offer_license" class="form-label">License</label>
                        <select id="offer_license" name="offer_license" class="form-control" required>
                            <option value="">Select a license</option>
                            {% for license in licenses %}
                            <option value="{{ license.name }}">{{ license.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="accessUrl" class="form-label">Offer Access URL</label>
                        <div class="input-group">
                            <div class="border p-3 w-100" style="border-radius: 8px; cursor: pointer; background-color: #f8f9fa; display: flex; align-items: center;">
                                <input type="url" id="accessUrl" name="accessUrl" class="form-control" placeholder="Enter the file URL manually, or click the button to upload a file" value="{{ form.accessUrl.value|default:'' }}">
                                <button type="button" class="btn btn-outline-danger ms-2" id="removeFileBtn" style="display:{% if form.accessUrl.value %}inline-block{% else %}none{% endif %}">Remove</button>
                                <input type="file" id="fileInput" name="file" multiple style="display:none;">
                                <button type="button" class="btn btn-outline-primary ms-2" id="fileUploadBtn">
                                    <i class="fas fa-upload"></i> Upload File
                                </button>
                            </div>
                        </div>
                    </div>
                    
                        <!-- Authentication for Access URL -->
                        <div class="form-group mt-3">
                            <label for="auth_type" class="form-label">Authentication</label>
                            <select id="auth_type" name="auth_type" class="form-control">
                                <option value="none">None</option>
                                <option value="basic">Basic (username/password)</option>
                                <option value="bearer">Bearer (token)</option>
                            </select>
                        </div>
                        <div class="form-group" id="basicAuthFields" style="display:none;">
                            <label class="form-label">Basic Authentication</label>
                            <input type="text" class="form-control mb-2" id="auth_username" name="auth_username" placeholder="Username">
                            <input type="password" class="form-control" id="auth_password" name="auth_password" placeholder="Password">
                        </div>
                        <div class="form-group" id="bearerAuthField" style="display:none;">
                            <label class="form-label">Bearer Token</label>
                            <input type="password" class="form-control" id="auth_token" name="auth_token" placeholder="Token">
                        </div>
                        <div class="form-group mt-2">
                            <button type="button" id="testAccessBtn" class="btn btn-secondary">Test Access</button>
                            <div id="testAccessResult" class="ms-3" style="display:inline-block; min-width:300px;"></div>
                        </div>
                        <div id="testAccessDetailsWrapper" class="mt-2" style="display:none;">
                            <a href="#" id="testAccessToggleDetails" class="small">Show details</a>
                            <pre id="testAccessDetails" class="mt-2 small text-muted" style="display:none; white-space:pre-wrap; background:#f8f9fa; padding:8px; border-radius:6px;">{}</pre>
                        </div>
                    
                    <hr>
                    <h4>Data Access Rules</h4>
                    <div class="form-group">
                        <label for="start" class="form-label">Access Start Date</label>
                        <input type="datetime-local" id="start" name="start" class="form-control" required value="{{ form.start.value|default:'' }}">
                    </div>
                    <div class="form-group">
                        <label for="end" class="form-label">Access End Date</label>
                        <input type="datetime-local" id="end" name="end" class="form-control" required value="{{ form.end.value|default:'' }}">
                    </div>
                    <div class="form-group">
                        <label for="access_policy" class="form-label">Access Policy</label>
                        <select id="access_policy" name="access_policy" class="form-control" required>
                            <option value="">Select access policy</option>
                            <option value="between_dates" {% if form.access_policy.value == 'between_dates' %}selected{% endif %}>Provide access between dates</option>
                        </select>
                        <input type="hidden" id="policy_value" name="value" value="{{ form.value.value|default:'' }}">
                    </div>
                    <hr>
                    <button type="submit" class="btn btn-primary mt-3">Provide the Offering</button>
                </form>
            </div>
        </div>
    </div>

    <script>
    document.addEventListener("DOMContentLoaded", function () {
        const accessPolicySelect = document.getElementById("access_policy");
        const policyValueInput = document.getElementById("policy_value");
        const startDateInput = document.getElementById("start");
        const endDateInput = document.getElementById("end");

        function updatePolicyValue() {
            if (accessPolicySelect.value === "between_dates") {
                const startDate = startDateInput.value;
                const endDate = endDateInput.value;
                if (startDate && endDate) {
                    policyValueInput.value = JSON.stringify({
                        type: "between_dates",
                        start: startDate,
                        end: endDate
                    });
                }
            } else {
                policyValueInput.value = "";
            }
        }

        // Update policy value when any of the inputs change
        startDateInput.addEventListener("change", updatePolicyValue);
        endDateInput.addEventListener("change", updatePolicyValue);
        accessPolicySelect.addEventListener("change", function () {
            if (accessPolicySelect.value === "between_dates") {
                // Construct policy value from start and end dates
                const startDate = document.getElementById("start").value;
                const endDate = document.getElementById("end").value;
                if (startDate && endDate) {
                    policyValueInput.value = JSON.stringify({
                        type: "between_dates",
                        start: startDate,
                        end: endDate
                    });
                }
            } else {
                policyValueInput.value = "";
            }
        });
    });
    </script>

    <!-- Copy URL Script -->
    <script>
        document.getElementById('copyUrlBtn').addEventListener('click', () => {
            const urlInput = document.getElementById('dataSpaceUrl');
            urlInput.select();
            document.execCommand('copy');
            alert('URL copied to clipboard!');
        });
    </script>

    <script>
        // Toggle auth fields
        document.addEventListener('DOMContentLoaded', function () {
            const authType = document.getElementById('auth_type');
            const basicFields = document.getElementById('basicAuthFields');
            const bearerField = document.getElementById('bearerAuthField');
            const testBtn = document.getElementById('testAccessBtn');
            const resultSpan = document.getElementById('testAccessResult');

            function updateAuthUI() {
                const v = authType.value;
                basicFields.style.display = v === 'basic' ? 'block' : 'none';
                bearerField.style.display = v === 'bearer' ? 'block' : 'none';
            }

            authType.addEventListener('change', updateAuthUI);
            updateAuthUI();

            function getCookie(name) {
                const value = `; ${document.cookie}`;
                const parts = value.split(`; ${name}=`);
                if (parts.length === 2) return parts.pop().split(';').shift();
            }

            testBtn.addEventListener('click', function () {
                const resultDiv = document.getElementById('testAccessResult');
                const detailsWrapper = document.getElementById('testAccessDetailsWrapper');
                const detailsPre = document.getElementById('testAccessDetails');
                const toggleLink = document.getElementById('testAccessToggleDetails');
                resultDiv.innerHTML = '<div class="d-inline-flex align-items-center text-muted"><span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span> Testing...</div>';
                detailsWrapper.style.display = 'none';
                detailsPre.style.display = 'none';
                // Build query params and call the endpoint with GET to avoid servers that reject POST
                const accessUrlVal = document.getElementById('accessUrl').value;
                const params = new URLSearchParams();
                params.append('accessUrl', accessUrlVal);
                params.append('auth_type', document.getElementById('auth_type').value || '');
                params.append('auth_username', document.getElementById('auth_username') ? document.getElementById('auth_username').value : '');
                params.append('auth_password', document.getElementById('auth_password') ? document.getElementById('auth_password').value : '');
                params.append('auth_token', document.getElementById('auth_token') ? document.getElementById('auth_token').value : '');

                fetch('{% url "provide:test_access" %}?'+params.toString(), {
                    method: 'GET',
                    credentials: 'same-origin'
                }).then(async r => {
                    let json = null; let text = null;
                    try { json = await r.clone().json(); } catch(e){ json = null; }
                    try { text = await r.clone().text(); } catch(e){ text = null; }
                    const status = r.status;
                    // normalize message and reason
                    const code = (json && (json.status_code || json.code)) || status || '—';
                    const reason = (json && (json.reason || json.message || json.error)) || r.statusText || '';
                    const detailsText = JSON.stringify(json, null, 2) || text || '';
                    if (r.ok && json && json.status === 'success') {
                        // success alert with badge and reason
                        resultDiv.innerHTML = `
                            <div class="alert alert-success d-flex align-items-start p-2 mb-0" role="alert">
                                <span class="badge rounded-pill bg-success me-3" style="min-width:48px;text-align:center;font-weight:600;">${code}</span>
                                <div>
                                    <h6 class="mb-1"><i class="fas fa-check-circle text-success me-1"></i>Accessible <small class="text-muted">${reason}</small></h6>
                                    <div class="small text-muted">The URL responded with status ${code}.</div>
                                </div>
                            </div>
                        `;
                        detailsPre.textContent = detailsText;
                        detailsWrapper.style.display = detailsPre.textContent ? 'block' : 'none';
                    } else {
                        // failure alert with badge and reason
                        resultDiv.innerHTML = `
                            <div class="alert alert-danger d-flex align-items-start p-2 mb-0" role="alert">
                                <span class="badge rounded-pill bg-danger me-3" style="min-width:48px;text-align:center;font-weight:600;">${code}</span>
                                <div>
                                    <h6 class="mb-1"><i class="fas fa-times-circle text-danger me-1"></i>Not accessible <small class="text-muted">${reason}</small></h6>
                                    <div class="small text-muted">${reason || 'The request failed. See details for more.'}</div>
                                </div>
                            </div>
                        `;
                        detailsPre.textContent = detailsText;
                        detailsWrapper.style.display = detailsPre.textContent ? 'block' : 'none';
                    }
                    // toggle details link
                    toggleLink.onclick = function (ev) {
                        ev.preventDefault();
                        if (detailsPre.style.display === 'none') { detailsPre.style.display = 'block'; toggleLink.textContent = 'Hide details'; }
                        else { detailsPre.style.display = 'none'; toggleLink.textContent = 'Show details'; }
                    };
                }).catch(err => {
                    resultDiv.innerHTML = `<div class="alert alert-warning p-2 mb-0" role="alert"><span class="badge bg-warning text-dark me-2">!</span><strong>Error</strong> — ${err.message}</div>`;
                });
            });
        });
    </script>

    <!-- File upload and removal functionality -->
    <script>
        document.addEventListener("DOMContentLoaded", function () {
            const accessUrlField = document.getElementById("accessUrl");
            const fileInput = document.getElementById("fileInput");
            const removeFileBtn = document.getElementById("removeFileBtn");
            const fileUploadBtn = document.getElementById("fileUploadBtn");

            // Handle manual URL input
            accessUrlField.addEventListener("input", () => {
                if (accessUrlField.value.trim() !== "") {
                    removeFileBtn.style.display = "none"; // Hide remove button
                    fileUploadBtn.style.display = "inline-block"; // Show upload button
                }
            });

            // Handle file selection from input
            fileInput.addEventListener("change", () => {
                handleFileUpload(fileInput.files);
            });

            // Trigger file input when the upload button is clicked
            fileUploadBtn.addEventListener("click", () => fileInput.click());

            // Store the OfferAccess UUID for the current provider action
            let offerAccessUuid = null;

            // Handle file upload logic
            function handleFileUpload(file) {
                if (!file || file.length === 0) return;

                const formData = new FormData();
                for (let i = 0; i < file.length; i++) {
                    formData.append("file", file[i]);
                }
                // If we already have an OfferAccess UUID, send it with the upload
                if (offerAccessUuid) {
                    formData.append("offer_access_uuid", offerAccessUuid);
                }

                fetch("/upload/", {
                    method: "POST",
                    body: formData,
                    headers: { "X-CSRFToken": "{{ csrf_token }}" }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.offer_access_url) {
                        // Set the accessUrl field to the Offer Access URL
                        accessUrlField.value = data.offer_access_url;
                        accessUrlField.readOnly = true;
                        removeFileBtn.style.display = "inline-block";
                        fileUploadBtn.style.display = "inline-block";
                        fileInput.value = '';
                        // Store the OfferAccess UUID for future uploads in this action
                        if (data.offer_access_uuid) {
                            offerAccessUuid = data.offer_access_uuid;
                        }
                        // Show a success message with the Offer Access URL and file URLs
                        let msg = `Files uploaded successfully!<br>`;
                        msg += `<strong>Offer Access URL:</strong> <a href='${data.offer_access_url}' target='_blank'>${data.offer_access_url}</a><br>`;
                        if (data.file_urls) {
                            data.file_urls.forEach((url, idx) => {
                                msg += `<strong>Raw File URL ${idx+1}:</strong> <a href='${url}' target='_blank'>${url}</a><br>`;
                            });
                        }
                        showUploadMessage(msg, true, true);
                    } else {
                        showUploadMessage('Upload failed: ' + (data.error || 'Unknown error'), false, false);
                    }
                })
                .catch(error => {
                    showUploadMessage('Error: ' + error.message, false, false);
                });

                // Helper to show upload result message
                function showUploadMessage(msg, success, append) {
                    let alertDiv = document.getElementById('uploadResultMsg');
                    if (!alertDiv) {
                        alertDiv = document.createElement('div');
                        alertDiv.id = 'uploadResultMsg';
                        accessUrlField.parentNode.appendChild(alertDiv);
                    }
                    if (append && success) {
                        alertDiv.innerHTML += `<div class='alert alert-success mt-2'>${msg}</div>`;
                    } else {
                        alertDiv.innerHTML = `<div class='alert alert-${success ? 'success' : 'danger'} mt-2'>${msg}</div>`;
                    }
                }
            }

            // Remove the uploaded file and reset the input for a new file upload
            removeFileBtn.addEventListener("click", () => {
                accessUrlField.value = ''; // Clear the URL field
                accessUrlField.readOnly = false; // Make the field editable again
                removeFileBtn.style.display = "none"; // Hide the "Remove File" button
                fileUploadBtn.style.display = "inline-block"; // Show the upload button again
                fileInput.value = ''; // Reset the file input to allow re-uploading
            });
        });
    </script>

</body>
</html>
